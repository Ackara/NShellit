<?xml version="1.0" encoding="utf-8" ?>

<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup>
    <ThisTargetFriendlyName>NShellet</ThisTargetFriendlyName>
    <NShelletPackageIdentifier Condition="$(NShelletPackageIdentifier) == ''">1</NShelletPackageIdentifier>
    <CanGeneratePackagesWithNShellet Condition ="$(TargetFramework.Contains('netcoreapp'))">True</CanGeneratePackagesWithNShellet>
    <GeneratePackagesWithNShelletOnBuild Condition="$(GeneratePackagesWithNShelletOnBuild) == ''">True</GeneratePackagesWithNShelletOnBuild>
    <OnlyGeneratePackagesWithNShelletInReleaseMode Condition="$(OnlyGeneratePackagesWithNShelletInReleaseMode) == ''">False</OnlyGeneratePackagesWithNShelletInReleaseMode>
  </PropertyGroup>

  <Choose>
    <When Condition="$(Configuration) != 'Release' And $(OnlyGeneratePackagesWithNShelletInReleaseMode)">
      <PropertyGroup>
        <ShouldGeneratePackagesWithNShellet>False</ShouldGeneratePackagesWithNShellet>
      </PropertyGroup>
    </When>
    <Otherwise>
      <PropertyGroup>
        <ShouldGeneratePackagesWithNShellet>True</ShouldGeneratePackagesWithNShellet>
      </PropertyGroup>
    </Otherwise>
  </Choose>

  <Target Name="GenerateModuleAfterBuild" AfterTargets="Build">
    <Message Condition="!$(CanGeneratePackagesWithNShellet)"
             Text="$(ThisTargetFriendlyName): Can only generate packages for netcoreapp a project." />

    <CallTarget Condition="$(GeneratePackagesWithNShelletOnBuild) And $(CanGeneratePackagesWithNShellet) And $(ShouldGeneratePackagesWithNShellet)"
                Targets="GeneratePackagesWithNShellet" />
  </Target>

  <Target Name="GeneratePackagesWithNShellet">
    <PropertyGroup>
      <NShelletTargetAssemblyFile>$(MSBuildProjectDirectory)\$(Outputpath)$(AssemblyName).dll</NShelletTargetAssemblyFile>
    </PropertyGroup>

    <Warning Condition="!Exists('$(NShelletTargetAssemblyFile)')"
             Text="$(ThisTargetFriendlyName): Could not find '$(NShelletTargetAssemblyFile)'." />

    <Exec Condition="Exists('$(NShelletTargetAssemblyFile)')" ContinueOnError="True"
          Command="dotnet &quot;$(NShelletTargetAssemblyFile)&quot; CA65CB33-397F-4F5A-851B-B2B0C8B11B94 &quot;$(NShelletTargetAssemblyFile)&quot; $(NShelletPackageIdentifier)">
      <Output TaskParameter="ExitCode" PropertyName="ErrorCode" />
    </Exec>

    <Message Condition="$(ErrorCode) == '0'"
             Text="$(ThisTargetFriendlyName): Finished generating packages for $(MSBuildProjectName)." />
  </Target>
</Project>