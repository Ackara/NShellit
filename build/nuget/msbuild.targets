<?xml version="1.0" encoding="utf-8" ?>

<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup>
    <NShellitPackageIdentifier Condition="$(NShellitPackageIdentifier) == ''">1</NShellitPackageIdentifier>
    <CanGeneratePackagesWithNShellit Condition="$(TargetFramework.Contains('netcoreapp'))">True</CanGeneratePackagesWithNShellit>
    <ShouldGeneratePackagesWithNShellitAfterPublish Condition="$(ShouldGeneratePackagesWithNShellitAfterPublish) == ''">True</ShouldGeneratePackagesWithNShellitAfterPublish>
  </PropertyGroup>

  <Target Name="GenerateModulesWithNShellitAfterPublish" AfterTargets="Publish">
    <Message Condition="$(CanGeneratePackagesWithNShellit) == 'False'"
             Text="Skipping target &quot;GeneratePackagesWithNShellit&quot; because the project's &lt;TargetFramework&gt; != 'netcorapp'." />

    <CallTarget Condition="($(ShouldGeneratePackagesWithNShellitAfterPublish) == 'True') AND ($(CanGeneratePackagesWithNShellit) == 'True')"
                Targets="GeneratePackagesWithNShellit" />
  </Target>

  <Target Name="GeneratePackagesWithNShellit">
    <PropertyGroup>
      <NShellitTargetAssemblyFile>$([System.IO.Path]::Combine('$(MSBuildProjectDirectory)', '$(Outputpath)', 'publish', '$(AssemblyName).dll'))</NShellitTargetAssemblyFile>
      <NShellitOutputDirectory Condition="$(NShellitOutputDirectory) == ''">$([System.IO.Path]::Combine('$(MSBuildProjectDirectory)', '$(OutputPath)', 'NShellit'))</NShellitOutputDirectory>
    </PropertyGroup>

    <Warning Condition="!Exists('$(NShellitTargetAssemblyFile)')"
             Text="NShellit: Could not find '$(NShellitTargetAssemblyFile)'." />

    <Exec Condition="Exists('$(NShellitTargetAssemblyFile)')" ContinueOnError="True"
          Command="dotnet &quot;$([System.IO.Path]::Combine('$(MSBuildProjectDirectory)', '$(Outputpath)', '$(AssemblyName).dll'))&quot; CA65CB33-397F-4F5A-851B-B2B0C8B11B94 $(NShellitPackageIdentifier) &quot;$(NShellitTargetAssemblyFile)&quot; &quot;$(NShellitOutputDirectory)&quot;" />
  </Target>
</Project>